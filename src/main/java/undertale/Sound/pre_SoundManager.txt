package undertale.Sound;
import javax.sound.sampled.*;
import undertale.Utils.ConfigManager;
import java.io.*;

// 重构后的音频管理器，移除享元模式，每次播放时都从文件系统加载音频
// 该设计不缓存音频资源，每次播放都创建新的Clip实例，占用更多内存和CPU资源
// 适用于音频文件较少或内存充足的场景
public class SoundManager
{
    private static final SoundManager instance = new SoundManager(); // 单例实例
    private java.util.HashMap<String, String> soundEffects; // 音效配置（逻辑名->路径）
    private java.util.HashMap<String, String> musicTracks; // 音乐配置（逻辑名->路径）
    
    private String currentMusicPath = null; // 当前正在播放的音乐路径
    private Clip currentMusicClip = null; // 当前音乐Clip实例
    private final Object musicLock = new Object();  // 音乐播放锁（保证线程安全）
    private float currentMusicVolume = 1.0f; // 当前音乐音量

    // 构造函数，初始化配置
    private SoundManager()
    {
        ConfigManager configManager = ConfigManager.getInstance();
        this.soundEffects = configManager.se;
        this.musicTracks = configManager.music;
    }
    
    // 获取单例实例
    public static SoundManager getInstance()
    {
        return instance;
    }
    
    // 设置Clip音量（0.0f-1.0f）
    private void setClipVolume(Clip clip, float volume)
    {
        if (clip != null && clip.isControlSupported(FloatControl.Type.MASTER_GAIN))
        {
            FloatControl gain = (FloatControl) clip.getControl(FloatControl.Type.MASTER_GAIN);
            float dB = (float) (Math.log10(Math.max(volume, 0.0001f)) * 20.0f); // 音量转分贝
            gain.setValue(Math.max(gain.getMinimum(), Math.min(gain.getMaximum(), dB)));
        }
    }
    
    // 加载音频文件为Clip
    private Clip loadClip(String path) throws Exception
    {
        AudioInputStream ais = null;
        try
        {
            // 优先从资源目录加载
            InputStream ris = getClass().getClassLoader().getResourceAsStream(path);
            if (ris != null)
            {
                ais = AudioSystem.getAudioInputStream(new BufferedInputStream(ris));
            }
            else
            {
                // 否则从文件系统加载
                File f = new File(path);
                if (!f.exists())
                {
                    throw new FileNotFoundException("Sound file not found: " + path);
                }
                ais = AudioSystem.getAudioInputStream(f);
            }
            // 格式转换为PCM_SIGNED
            AudioFormat baseFormat = ais.getFormat();
            AudioFormat decodedFormat = new AudioFormat(
                    AudioFormat.Encoding.PCM_SIGNED,
                    baseFormat.getSampleRate(),
                    16,
                    baseFormat.getChannels(),
                    baseFormat.getChannels() * 2,
                    baseFormat.getSampleRate(),
                    false);
            AudioInputStream dais = AudioSystem.getAudioInputStream(decodedFormat, ais);
            // 创建Clip并打开
            Clip clip = AudioSystem.getClip();
            clip.open(dais);
            return clip;
        }
        finally
        {
            if (ais != null)
            {
                try
                {
                    ais.close();
                }
                catch (Exception ignored){}
            }
        }
    }
    
    // 播放音效（默认音量1.0）
    public void playSE(String soundFile)
    {
        playSE(soundFile, 1.0f);
    }
    
    // 播放音效（可指定音量）
    public void playSE(String soundFile, float volume)
    {
        try {
            // 获取音效路径（支持逻辑名和直接路径）
            String path = (soundEffects != null && soundEffects.containsKey(soundFile)
                    ? soundEffects.get(soundFile)
                    : soundFile);
            // 每次播放都创建新的Clip实例
            Clip clip = loadClip(path);
            if (clip == null)
            {
                return;
            }
            setClipVolume(clip, volume);
            clip.start();
            
            // 在播放结束后自动关闭Clip释放资源
            Thread closeThread = new Thread(() -> {
                try {
                    Thread.sleep(clip.getMicrosecondLength() / 1000);
                    clip.close();
                } catch (InterruptedException e) {
                    clip.close();
                }
            });
            closeThread.setDaemon(true);
            closeThread.start();
        }
        catch (Exception e){}
    }
    
    // 播放背景音乐（默认音量）
    public void playMusic(String musicFile)
    {
        playMusic(musicFile, currentMusicVolume);
    }
    
    // 播放背景音乐（可指定音量）
    public void playMusic(String musicFile, float volume)
    {
        synchronized (musicLock) // 保证线程安全
        { 
            try
            {
                stopMusic(); // 停止当前音乐
                String path = (musicTracks != null && musicTracks.containsKey(musicFile) ? musicTracks.get(musicFile) : musicFile);// 获取音乐路径
                // 每次播放都创建新的Clip实例
                Clip clip = loadClip(path);
                if (clip != null)
                {
                    currentMusicClip = clip;
                    currentMusicPath = path;
                    setClipVolume(currentMusicClip, volume);
                    currentMusicVolume = volume;
                    if (currentMusicClip.isRunning()) currentMusicClip.stop();
                    currentMusicClip.setFramePosition(0);
                    currentMusicClip.loop(Clip.LOOP_CONTINUOUSLY); // 循环播放
                    currentMusicClip.start();
                }
            }
            catch (Exception e) {}
        }
    }
    
    // 设置当前音乐音量
    public void setCurrentMusicVolume(float volume)
    {
        synchronized (musicLock)
        {
            currentMusicVolume = volume;
            if (currentMusicClip != null)
            {
                setClipVolume(currentMusicClip, volume);
            }
        }
    }
    
    // 停止音乐播放
    public void stopMusic()
    {
        synchronized (musicLock)
        {
            if (currentMusicClip != null)
            {
                try
                {
                    currentMusicClip.stop();
                    currentMusicClip.close();
                }
                catch (Exception ignored) {}
                currentMusicClip = null;
                currentMusicPath = null;
            }
        }
    }
    
    // 停止所有音效
    public void stopAllSe()
    {
        // 由于音效没有缓存，无法批量停止
        // 此方法在非享元模式下无实际作用
    }
    
    // 停止指定音效
    public void stopSe(String soundFile)
    {
        // 由于音效没有缓存，无法停止特定音效
        // 此方法在非享元模式下无实际作用
    }
    
    // 检查音效是否正在播放
    public boolean isSePlaying(String soundFile)
    {
        // 由于音效没有缓存，无法检查特定音效是否正在播放
        // 此方法在非享元模式下无实际作用，总是返回false
        return false;
    }
    
    // 关闭SoundManager，释放所有资源
    public void shutdown() {
        stopMusic();
        // 由于没有缓存池，不需要额外清理
    }
    
    // 检查指定音乐是否正在播放
    public boolean isMusicPlaying(String musicName)
    {
        if(currentMusicPath == null || musicTracks == null)
        {
            return false;
        }
        String path = musicTracks.get(musicName);
        return currentMusicPath.equals(path) && currentMusicClip != null && currentMusicClip.isRunning();
    }
}