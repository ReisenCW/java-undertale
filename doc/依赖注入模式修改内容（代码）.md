# 使用依赖注入模式重构内容

## EnemyManager.java
- 重构前
```java
public class EnemyManager {
	private ArrayList<Enemy> enemies;
    private static EnemyManager instance;

    private Enemy currentEnemy = null;

    static {
        instance = new EnemyManager();
    }

	private EnemyManager() {
		enemies = new ArrayList<>();
        init();
    }

    public static EnemyManager getInstance() {
        if(instance == null) {
            synchronized(EnemyManager.class) {
                if(instance == null) {
                    instance = new EnemyManager();
                }
            }
        }
        return instance;
    }

    private void init() {
        // 创建Titan敌人
        Titan titan = new Titan();
        addEnemy(titan);
        setCurrentEnemy(0);
    }

```
- 重构后
```java
public class EnemyManager {
	private ArrayList<Enemy> enemies;
    // private static EnemyManager instance; // Removed Singleton

    private Enemy currentEnemy = null;

    // static {
    //    instance = new EnemyManager();
    // }

	public EnemyManager(Player player) { // Made public
		enemies = new ArrayList<>();
        init(player);
    }

    // public static EnemyManager getInstance() { ... } // Removed

    private void init(Player player) {
        // 创建Titan敌人
        Titan titan = new Titan(player);
        addEnemy(titan);
        setCurrentEnemy(0);
    }
```

## Game.java
- 重构前
```java
public class Game {
    private static boolean allowDebug = true;

    private static Window gameWindow;

    public static ConfigManager configManager;
    private static Renderer renderer;
	private static Player player;
    private static SceneManager sceneManager;
    private static ObjectManager objectManager;
    private static InputManager inputManager;
    private static UIManager uiManager;
    private static TextureManager textureManager;
    private static FontManager fontManager;
    private static ScreenFadeManager screenFadeManager;
    private static ShaderManager shaderManager;

    public static void run() {
		init();
		loop();
        destroy();
	}

    private static void destroy() {
        textureManager.destroyAll();
        fontManager.destroy();
        objectManager.destroy();
        shaderManager.dispose();
		gameWindow.destroyWindow();
    }

	private static void init() {
        configManager = ConfigManager.getInstance();
        gameWindow = new Window(configManager.WINDOW_WIDTH, configManager.WINDOW_HEIGHT, "Undertale");
        shaderManager = ShaderManager.getInstance();
        textureManager = TextureManager.getInstance();
        sceneManager = SceneManager.getInstance();
		player = new Player("Frisk");
        objectManager = new ObjectManager(player);
        EscapeInputObserver escapeObserver = new EscapeInputObserver(gameWindow);
        inputManager = new InputManager(gameWindow);
        inputManager.addObserver(escapeObserver);
        inputManager.addObserver(new DebugInputObserver(allowDebug));
        fontManager = FontManager.getInstance();
        screenFadeManager = ScreenFadeManager.getInstance();

        SceneFactory sceneFactory = new SceneFactory(objectManager, inputManager);

        // 初始化场景管理器并注册场景
        sceneManager.registerScene(SceneEnum.START_MENU,
        sceneFactory.creatScene(SceneEnum.START_MENU));
        sceneManager.registerScene(SceneEnum.BATTLE_MENU,
        sceneFactory.creatScene(SceneEnum.BATTLE_MENU));
        sceneManager.registerScene(SceneEnum.BATTLE_FIGHT,
        sceneFactory.creatScene(SceneEnum.BATTLE_FIGHT));
        sceneManager.registerScene(SceneEnum.GAME_OVER,
        sceneFactory.creatScene(SceneEnum.GAME_OVER));
        
        // 初始场景
        sceneManager.switchScene(SceneEnum.START_MENU, true);
        
        // 初始化UI管理器
        uiManager = UIManager.getInstance();
        
        // 初始化渲染器
        renderer = new Renderer(escapeObserver);
	}

	private static void loop() {
        Timer timer = new Timer();
		while ( !glfwWindowShouldClose(gameWindow.getWindow()) ) {
            timer.setTimerStart();
			update(timer.getDeltaTime());
			render();
			timer.delayIfNeeded();
		}
	}

    private static void update(float deltaTime) {
        // 场景更新
        Scene currentScene = sceneManager.getCurrentScene();
        if (currentScene != null) {
            currentScene.update(deltaTime);
        }
        // 输入处理
		inputManager.processInput();
        // ui更新
        uiManager.update(deltaTime);
        // 屏幕淡入淡出更新
        screenFadeManager.update(deltaTime);
    }

    private static void render() {
        renderer.render();
    }
    
    public static Window getWindow() {
        return gameWindow;
    }

    public static int getWindowWidth() {
        return configManager.WINDOW_WIDTH;
    }

    public static int getWindowHeight() {
        return configManager.WINDOW_HEIGHT;
    }

    public static Renderer getRenderer() {
        return renderer;
    }

	public static Player getPlayer() {
		return player;
	}

    public static ObjectManager getObjectManager() {
        return objectManager;
    }

    public static InputManager getInputManager() {
        return inputManager;
    }

    public static UIManager getUIManager() {
        return uiManager;
    }

    public static Texture getTexture(String name) {
        return textureManager.getTexture(name);
    }

    public static float getFrameHeight() {
        return uiManager.getFrameHeight();
    }

    public static float getFrameWidth() {
        return uiManager.getFrameWidth();
    }

    public static float getFrameLeft() {
        return uiManager.getFrameLeft();
    }

    public static float getFrameBottom() {
        return uiManager.getFrameBottom();
    }

    public static void resetGame(UIManager.MenuState menuState) {
        objectManager.resetGame();
        uiManager.resetVars(menuState);
        sceneManager.reset();
    }
}
- 重构后
```java

public class Game {
    private static Game instance;

    private boolean allowDebug = true;

    private Window gameWindow;

    private ConfigManager configManager;
    private Renderer renderer;
	private Player player;
    private SceneManager sceneManager;
    private ObjectManager objectManager;
    private InputManager inputManager;
    private UIManager uiManager;
    private EnemyManager enemyManager;
    private TextureManager textureManager;
    private FontManager fontManager;
    private ScreenFadeManager screenFadeManager;
    private ShaderManager shaderManager;

    public Game() {
        // Constructor
    }

    public static Game getInstance() {
        if (instance == null) {
            instance = new Game();
        }
        return instance;
    }

    public void run() {
		init();
		loop();
        destroy();
	}

    private void destroy() {
        textureManager.destroyAll();
        fontManager.destroy();
        objectManager.destroy();
        shaderManager.dispose();
		gameWindow.destroyWindow();
    }

	private void init() {
        configManager = ConfigManager.getInstance();
        gameWindow = new Window(configManager.WINDOW_WIDTH, configManager.WINDOW_HEIGHT, "Undertale");
        shaderManager = ShaderManager.getInstance();
        textureManager = TextureManager.getInstance();
        sceneManager = SceneManager.getInstance();

        player = new Player("Frisk");
        // Initialize EnemyManager
        enemyManager = new EnemyManager();

        objectManager = new ObjectManager(player, enemyManager);
        EscapeInputObserver escapeObserver = new EscapeInputObserver(gameWindow);
        inputManager = new InputManager(gameWindow);
        inputManager.addObserver(escapeObserver);
        inputManager.addObserver(new DebugInputObserver(allowDebug));
        fontManager = FontManager.getInstance();
        
        // Initialize ScreenFadeManager with dimensions
        ScreenFadeManager.init(configManager.WINDOW_WIDTH, configManager.WINDOW_HEIGHT);
        screenFadeManager = ScreenFadeManager.getInstance();

        // Initialize UIManager
        uiManager = new UIManager(player, enemyManager, SoundManager.getInstance(), fontManager);

        SceneFactory sceneFactory = new SceneFactory(objectManager, inputManager, uiManager, enemyManager);

        // 初始化场景管理器并注册场景
        sceneManager.registerScene(SceneEnum.START_MENU,
        sceneFactory.creatScene(SceneEnum.START_MENU));
        sceneManager.registerScene(SceneEnum.BATTLE_MENU,
        sceneFactory.creatScene(SceneEnum.BATTLE_MENU));
        sceneManager.registerScene(SceneEnum.BATTLE_FIGHT,
        sceneFactory.creatScene(SceneEnum.BATTLE_FIGHT));
        sceneManager.registerScene(SceneEnum.GAME_OVER,
        sceneFactory.creatScene(SceneEnum.GAME_OVER));
        
        // 初始场景
        sceneManager.switchScene(SceneEnum.START_MENU, true);
        
        // 初始化渲染器 - Inject dependencies
        renderer = new Renderer(escapeObserver, sceneManager, fontManager, screenFadeManager, gameWindow, configManager.WINDOW_WIDTH, configManager.WINDOW_HEIGHT);
	}

	private void loop() {
        Timer timer = new Timer();
		while ( !glfwWindowShouldClose(gameWindow.getWindow()) ) {
            timer.setTimerStart();
			update(timer.getDeltaTime());
			render();
			timer.delayIfNeeded();
		}
	}

    private void update(float deltaTime) {
        // 场景更新
        Scene currentScene = sceneManager.getCurrentScene();
        if (currentScene != null) {
            currentScene.update(deltaTime);
        }
        // 输入处理
		inputManager.processInput();
        // ui更新
        uiManager.update(deltaTime);
        // 屏幕淡入淡出更新
        screenFadeManager.update(deltaTime);
    }

    private void render() {
        renderer.render();
    }
    
    public static Window getWindow() {
        return getInstance().gameWindow;
    }

    public static int getWindowWidth() {
        return getInstance().configManager.WINDOW_WIDTH;
    }

    public static int getWindowHeight() {
        return getInstance().configManager.WINDOW_HEIGHT;
    }

    public static Renderer getRenderer() {
        return getInstance().renderer;
    }

	public static Player getPlayer() {
		return getInstance().player;
	}

    public static ObjectManager getObjectManager() {
        return getInstance().objectManager;
    }

    public static InputManager getInputManager() {
        return getInstance().inputManager;
    }

    public static UIManager getUIManager() {
        return getInstance().uiManager;
    }

    public static Texture getTexture(String name) {
        return getInstance().textureManager.getTexture(name);
    }

    public static float getFrameHeight() {
        return getInstance().uiManager.getFrameHeight();
    }

    public static float getFrameWidth() {
        return getInstance().uiManager.getFrameWidth();
    }

    public static float getFrameLeft() {
        return getInstance().uiManager.getFrameLeft();
    }

    public static float getFrameBottom() {
        return getInstance().uiManager.getFrameBottom();
    }

    public static void resetGame(UIManager.MenuState menuState) {
        getInstance().objectManager.resetGame();
        getInstance().uiManager.resetVars(menuState);
        getInstance().sceneManager.reset();
    }
}
```

## Renderer.java
- 重构前
```java
public class Renderer {
    private SceneManager sceneManager;
    private FontManager fontManager;
    private ScreenFadeManager screenFadeManager;
    private EscapeInputObserver escapeObserver;
    private Window window;

    private final int ESCAPING_X = 50;
    private final int ESCAPING_Y = 50;
    Renderer(EscapeInputObserver escapeObserver) {
        this.escapeObserver = escapeObserver;
        this.sceneManager = SceneManager.getInstance();
        this.fontManager = FontManager.getInstance();
        this.screenFadeManager = ScreenFadeManager.getInstance();
        this.window = Game.getWindow();
        init();
    }

    private void init() {
        // 开启混合(透明度)
        glEnable(GL_BLEND);
        // 计算方式: 源颜色的alpha值决定源颜色的贡献度, (1 - 源颜色的alpha)决定目标颜色的贡献度
        glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
        // 设置视口为窗口大小, 左下角为(0,0)
        glViewport(0, 0, Game.getWindowWidth(), Game.getWindowHeight());
    }
}
```
- 重构后
```java
public class Renderer {
    private SceneManager sceneManager;
    private FontManager fontManager;
    private ScreenFadeManager screenFadeManager;
    private EscapeInputObserver escapeObserver;
    private Window window;

    private final int ESCAPING_X = 50;
    private final int ESCAPING_Y = 50;
    private int width;
    private int height;

    // 使用依赖注入重构构造函数，传入所需依赖
    Renderer(EscapeInputObserver escapeObserver, SceneManager sceneManager, FontManager fontManager, ScreenFadeManager screenFadeManager, Window window, int width, int height) {
        this.escapeObserver = escapeObserver;
        this.sceneManager = sceneManager;
        this.fontManager = fontManager;
        this.screenFadeManager = screenFadeManager;
        this.window = window;
        this.width = width;
        this.height = height;
        init();
    }

    private void init() {
        // 开启混合(透明度)
        glEnable(GL_BLEND);
        // 计算方式: 源颜色的alpha值决定源颜色的贡献度, (1 - 源颜色的alpha)决定目标颜色的贡献度
        glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);
        // 设置视口为窗口大小, 左下角为(0,0)
        glViewport(0, 0, width, height);
    }
}
```

## ObjectManager.java
- 重构前
```java
    public ObjectManager(Player player){
        init(player);
    }

    /**
     * No-arg constructor for tests that don't need a fully initialized Player.
     * Initializes internal collections and layers only.
     */
    ObjectManager() {
        init(null);
    }

    private void init(Player player){
        this.player = player;
        // bullets list removed; bulletsLayer will hold active bullets
        pendingBullets = new ArrayList<>();
        bulletPool = new ArrayList<>();
        toRemove = new ArrayList<>();
        collectables = new ArrayList<>();
        collectablePool = new ArrayList<>();
        collectablesToRemove = new ArrayList<>();
        rippleEffects = new ArrayList<>();
        titanSpawnParticles = new ArrayList<>();
        // create composite root and layers
        root = new GameObjectComposite();
        bulletsLayer = new GameObjectComposite();
        collectablesLayer = new GameObjectComposite();
        effectsLayer = new GameObjectComposite();
        root.addChild(bulletsLayer);
        root.addChild(collectablesLayer);
        root.addChild(effectsLayer);
        // In test-only construction (player == null) avoid triggering global singletons
        if (player != null) {
            enemyManager = EnemyManager.getInstance();
            // bulletRenderer / collectableRenderer removed in favor of GameObject.render()
            soundManager = SoundManager.getInstance();
        } else {
            enemyManager = null;
            soundManager = null;
        }
    }
```
- 重构后
```java
    public ObjectManager(Player player, EnemyManager enemyManager){
        init(player, enemyManager);
    }

    /**
     * No-arg constructor for tests that don't need a fully initialized Player.
     * Initializes internal collections and layers only.
     */
    ObjectManager() {
        init(null, null);
    }

    private void init(Player player, EnemyManager enemyManager){
        this.player = player;
        this.enemyManager = enemyManager;
        // bullets list removed; bulletsLayer will hold active bullets
        pendingBullets = new ArrayList<>();
        bulletPool = new ArrayList<>();
        toRemove = new ArrayList<>();
        collectables = new ArrayList<>();
        collectablePool = new ArrayList<>();
        collectablesToRemove = new ArrayList<>();
        rippleEffects = new ArrayList<>();
        titanSpawnParticles = new ArrayList<>();
        // create composite root and layers
        root = new GameObjectComposite();
        bulletsLayer = new GameObjectComposite();
        collectablesLayer = new GameObjectComposite();
        effectsLayer = new GameObjectComposite();
        root.addChild(bulletsLayer);
        root.addChild(collectablesLayer);
        root.addChild(effectsLayer);
        // In test-only construction (player == null) avoid triggering global singletons
        if (player != null) {
            // bulletRenderer / collectableRenderer removed in favor of GameObject.render()
            soundManager = SoundManager.getInstance();
        } else {
            soundManager = null;
        }
    }
```

## Main.java
- 重构前
```java
package undertale;
import undertale.GameMain.Game;

public class Main {
	public static void main(String[] args) {
		Game.run();
	}
}
```
- 重构后
```java
package undertale;
import undertale.GameMain.Game;

public class Main {
	public static void main(String[] args) {
		Game.getInstance().run();
	}
}
```

## BattleFightScene.java
- 重构前
```java
public class BattleFightScene extends Scene {
    private EnemyManager enemyManager = EnemyManager.getInstance();
    private int phase = 0; // 0-3
    private int phaseRound = 0; // 0-2
    private ArrayList<Round> rounds;
    private long roundTime;
    private boolean isSpecial = false;

    public BattleFightScene(ObjectManager objectManager, InputManager inputManager) {
        super(objectManager, inputManager);
        init();
    }

    @Override
    public void init() {
        phase = 0;
        phaseRound = -1;
        // phase = 1; // test
        // phaseRound = 1; //test
        rounds = new ArrayList<>();
        // 4个阶段, 前三个阶段每个阶段3个round
        // 0-2, 4-6, 8-10
        // 3,7,11为special round, 只有使用了unleash之后才会进入该round
        for(int p = 0; p < 3; p++) {
            rounds.add(new RoundSwarm(p + 1, 16000, 1500));
            rounds.add(new RoundSnake(p + 1, 17000, 1500));
            rounds.add(new RoundFinger(p + 1, 22000, 1500));
            rounds.add(new RoundSpecial(p + 1, 17000, 1500));
        }
        rounds.add(new RoundSpecial(3, 17000, 1500)); // 循环最后一个攻击
        roundTime = 0;
    }
}
```
- 重构后
```java

public class BattleFightScene extends Scene {
    private EnemyManager enemyManager;
    private int phase = 0; // 0-3
    private int phaseRound = 0; // 0-2
    private ArrayList<Round> rounds;
    private long roundTime;
    private boolean isSpecial = false;

    public BattleFightScene(ObjectManager objectManager, InputManager inputManager, UIManager uiManager, EnemyManager enemyManager) {
        super(objectManager, inputManager, uiManager);
        this.enemyManager = enemyManager;
        init();
    }

    @Override
    public void init() {
        phase = 0;
        phaseRound = -1;
        // phase = 1; // test
        // phaseRound = 1; //test
        rounds = new ArrayList<>();
        // 4个阶段, 前三个阶段每个阶段3个round
        // 0-2, 4-6, 8-10
        // 3,7,11为special round, 只有使用了unleash之后才会进入该round
        for(int p = 0; p < 3; p++) {
            rounds.add(new RoundSwarm(p + 1, 16000, 1500, uiManager));
            rounds.add(new RoundSnake(p + 1, 17000, 1500, uiManager));
            rounds.add(new RoundFinger(p + 1, 22000, 1500, uiManager));
            rounds.add(new RoundSpecial(p + 1, 17000, 1500, uiManager, enemyManager));
        }
        rounds.add(new RoundSpecial(3, 17000, 1500, uiManager, enemyManager)); // 循环最后一个攻击
        roundTime = 0;
    }
}
```

## BattleMenuScene.java
- 重构前
```java
public class BattleMenuScene extends Scene {
    private EnemyManager enemyManager = EnemyManager.getInstance();
    private int round;
    private long battleFrameResetTime = 1000; // 1000ms

    private String[] roundMessages = {
        "* The titan appeared.",
        "* A swarm is coming.",
        "* The titan's hands are moving."
    };

    public BattleMenuScene(ObjectManager objectManager, InputManager inputManager) {
        super(objectManager, inputManager);
        init();
    }
```
- 重构后
```java
public class BattleMenuScene extends Scene {
    private EnemyManager enemyManager;
    private int round;
    private long battleFrameResetTime = 1000; // 1000ms

    private String[] roundMessages = {
        "* The titan appeared.",
        "* A swarm is coming.",
        "* The titan's hands are moving."
    };

    public BattleMenuScene(ObjectManager objectManager, InputManager inputManager, UIManager uiManager, EnemyManager enemyManager) {
        super(objectManager, inputManager, uiManager);
        this.enemyManager = enemyManager;
        init();
    }
```

## BeginMenuScene.java
- 重构前
```java
    public BeginMenuScene(ObjectManager objectManager, InputManager inputManager) {
        super(objectManager, inputManager);
    }
```
- 重构后
```java
    public BeginMenuScene(ObjectManager objectManager, InputManager inputManager, UIManager uiManager) {
        super(objectManager, inputManager, uiManager);
    }
```

## GameOverScene.java
- 重构前
```java
    public GameOverScene(ObjectManager objectManager, InputManager inputManager) {
        super(objectManager, inputManager);
    }
```
- 重构后
```java
    public GameOverScene(ObjectManager objectManager, InputManager inputManager, UIManager uiManager) {
        super(objectManager, inputManager, uiManager);
    }
```

## Round.java
- 重构前
```java
    public Round(long duration, long frameMoveTime) {
        this.roundDuration = duration;
        this.frameMoveTime = frameMoveTime;
        objectManager = Game.getObjectManager();
        uiManager = UIManager.getInstance();
    }
```
- 重构后
```java
    public Round(long duration, long frameMoveTime, UIManager uiManager) {
        this.roundDuration = duration;
        this.frameMoveTime = frameMoveTime;
        objectManager = Game.getObjectManager();
        this.uiManager = uiManager;
    }
```

## RoundFinger.java
- 重构前
```java
    public RoundFinger(int intensity, long duration, long frameMoveTime) {
        super(duration, frameMoveTime);
        this.intensity = intensity;
        this.edge = 400.0f;
        this.centerX = Game.getWindowWidth() / 2.0f;
        this.centerY = Game.getWindowHeight() / 2.0f;
    }
```
- 重构后
```java
    public RoundFinger(int intensity, long duration, long frameMoveTime, UIManager uiManager) {
        super(duration, frameMoveTime, uiManager);
        this.intensity = intensity;
        this.edge = 400.0f;
        this.centerX = Game.getWindowWidth() / 2.0f;
        this.centerY = Game.getWindowHeight() / 2.0f;
    }
```

## RoundSnake.java
- 重构前
```java
    public RoundSnake(int intensity, long duration, long frameMoveTime) {
        super(duration, frameMoveTime);
```
- 重构后
```java
    public RoundSnake(int intensity, long duration, long frameMoveTime, UIManager uiManager) {
        super(duration, frameMoveTime, uiManager);
```

## RoundSpecial.java
- 重构前
```java
    public RoundSpecial(int intensity, long duration, long frameMoveTime) {
        super(duration, frameMoveTime);
        SHOOT_NUM = intensity;
        animationManager = AnimationManager.getInstance();
        titanSpawnAnimation = animationManager.getAnimation("titan_spawn_animation");
        ballBlastTexture = TextureManager.getInstance().getTexture("titan_blast_black");
        ballBlastWidth = ballBlastTexture.getWidth();
        ballBlastHeight = ballBlastTexture.getHeight();
        float pos[] = Titan.getCentralPosition();
        ballX = pos[0] - ballBlastWidth / 2 * blastBaseScale;
        ballY = pos[1] - ballBlastHeight / 2 * blastBaseScale;

    }
    
    @Override
    public void updateRound(float deltaTime) {
        spawnTimer += deltaTime;
        cooldownTimer += deltaTime;
        
        if (spawnTimer >= SPAWN_INTERVAL) {
            spawnTimer -= SPAWN_INTERVAL;
            spawnTitanSpawn();
        }
        if (cooldownTimer >= SHOOT_COOLDOWN && shootCount == 0 && !isCharging) {
            isCharging = true;
            chargeTimer = 0.0f;
            lineSpawnTimer = 0.0f;
            SoundManager.getInstance().playSE("blast_charge");
        }
        if (isCharging) {
            chargeTimer += deltaTime;
            lineSpawnTimer += deltaTime;
            // titan震动
            EnemyManager enemyManager = EnemyManager.getInstance();
            Titan titan = (Titan) enemyManager.getCurrentEnemy();
            if (titan != null) {
                titan.setShakeOffset((float) Math.sin(chargeTimer * 80) * 8);
            }
……
```
- 重构后
```java
    private EnemyManager enemyManager;

    public RoundSpecial(int intensity, long duration, long frameMoveTime, UIManager uiManager, EnemyManager enemyManager) {
        super(duration, frameMoveTime, uiManager);
        this.enemyManager = enemyManager;
        SHOOT_NUM = intensity;
        animationManager = AnimationManager.getInstance();
        titanSpawnAnimation = animationManager.getAnimation("titan_spawn_animation");
        ballBlastTexture = TextureManager.getInstance().getTexture("titan_blast_black");
        ballBlastWidth = ballBlastTexture.getWidth();
        ballBlastHeight = ballBlastTexture.getHeight();
        float pos[] = Titan.getCentralPosition();
        ballX = pos[0] - ballBlastWidth / 2 * blastBaseScale;
        ballY = pos[1] - ballBlastHeight / 2 * blastBaseScale;

    }
    
    @Override
    public void updateRound(float deltaTime) {
        spawnTimer += deltaTime;
        cooldownTimer += deltaTime;
        
        if (spawnTimer >= SPAWN_INTERVAL) {
            spawnTimer -= SPAWN_INTERVAL;
            spawnTitanSpawn();
        }
        if (cooldownTimer >= SHOOT_COOLDOWN && shootCount == 0 && !isCharging) {
            isCharging = true;
            chargeTimer = 0.0f;
            lineSpawnTimer = 0.0f;
            SoundManager.getInstance().playSE("blast_charge");
        }
        if (isCharging) {
            chargeTimer += deltaTime;
            lineSpawnTimer += deltaTime;
            // titan震动
            // EnemyManager enemyManager = EnemyManager.getInstance();
            Titan titan = (Titan) enemyManager.getCurrentEnemy();
            if (titan != null) {
                titan.setShakeOffset((float) Math.sin(chargeTimer * 80) * 8);
            }
……
```

## RoundSwarm.java
- 重构前
```java
    public RoundSwarm(int intensity, long duration, long frameMoveTime) {
        super(duration, frameMoveTime);
```
- 重构后
```java
    public RoundSwarm(int intensity, long duration, long frameMoveTime, UIManager uiManager) {
        super(duration, frameMoveTime, uiManager);
```

## Scene.java
- 重构前
```java
    public Scene(ObjectManager objectManager, InputManager inputManager) {
        this.sceneManager = SceneManager.getInstance();
        this.uiManager = UIManager.getInstance();
```
- 重构后
```java
    public Scene(ObjectManager objectManager, InputManager inputManager, UIManager uiManager) {
        this.sceneManager = SceneManager.getInstance();
        this.uiManager = uiManager;
```

## SceneFactory.java
- 重构前
```java
package undertale.Scene;

import undertale.GameMain.InputManager;
import undertale.GameObject.ObjectManager;
import undertale.Scene.Scene.SceneEnum;

public class SceneFactory {
    private ObjectManager objectManager;
    private InputManager inputManager;

    public SceneFactory(ObjectManager objectManager, InputManager inputManager) {
        this.objectManager = objectManager;
        this.inputManager = inputManager;
    }

    public Scene creatScene(SceneEnum type) {
        return switch (type) {
            case BATTLE_MENU -> new BattleMenuScene(objectManager, inputManager);
            case BATTLE_FIGHT -> new BattleFightScene(objectManager, inputManager);
            case GAME_OVER -> new GameOverScene(objectManager, inputManager);
            case START_MENU -> new BeginMenuScene(objectManager, inputManager);
        };
    }
}
```

- 重构后
```java
package undertale.Scene;

import undertale.Enemy.EnemyManager;
import undertale.GameMain.InputManager;
import undertale.GameObject.ObjectManager;
import undertale.Scene.Scene.SceneEnum;
import undertale.UI.UIManager;

public class SceneFactory {
    private ObjectManager objectManager;
    private InputManager inputManager;
    private UIManager uiManager;
    private EnemyManager enemyManager;

    public SceneFactory(ObjectManager objectManager, InputManager inputManager, UIManager uiManager, EnemyManager enemyManager) {
        this.objectManager = objectManager;
        this.inputManager = inputManager;
        this.uiManager = uiManager;
        this.enemyManager = enemyManager;
    }

    public Scene creatScene(SceneEnum type) {
        return switch (type) {
            case BATTLE_MENU -> new BattleMenuScene(objectManager, inputManager, uiManager, enemyManager);
            case BATTLE_FIGHT -> new BattleFightScene(objectManager, inputManager, uiManager, enemyManager);
            case GAME_OVER -> new GameOverScene(objectManager, inputManager, uiManager);
            case START_MENU -> new BeginMenuScene(objectManager, inputManager, uiManager);
        };
    }
}
```

## AttackAnimManager.java
- 重构前
```java
    public AttackAnimManager(FontManager fontManager, Player player) {
        super();
        this.fontManager = fontManager;
        this.soundManager = SoundManager.getInstance();
        this.enemyManager = EnemyManager.getInstance();
        this.player = player;
        animationManager = AnimationManager.getInstance();
        attackBarOffset = 0.0f;
        attackBarIndex = 0;
        attackBarDuration = 2100;
        loadResources();
    }
```
- 重构后
```java
    public AttackAnimManager(FontManager fontManager, Player player, EnemyManager enemyManager) {
        super();
        this.fontManager = fontManager;
        this.soundManager = SoundManager.getInstance();
        this.enemyManager = enemyManager;
        this.player = player;
        animationManager = AnimationManager.getInstance();
        attackBarOffset = 0.0f;
        attackBarIndex = 0;
        attackBarDuration = 2100;
        loadResources();
    }
```

## ScreenFadeManager.java
- 重构前
```java
public class ScreenFadeManager{
    public enum State {
        INACTIVE,
        FADING_OUT,
        FADING_IN,
        FADING_OUT_FINAL
    }

    private static ScreenFadeManager instance;

    private State state;
    private float timer;
    private float fadeDuration; // 淡化时间(单段)
    private Runnable onMidpoint; // 在淡出完全变黑时调用
    private Runnable onComplete; // 在淡入完全变亮时调用
    private float WINDOW_WIDTH;
    private float WINDOW_HEIGHT;

    static {
        instance = new ScreenFadeManager();
    }

    private ScreenFadeManager() {
        state = State.INACTIVE;
        timer = 0.0f;
        fadeDuration = 1.0f;
        WINDOW_WIDTH = Game.getWindowWidth();
        WINDOW_HEIGHT = Game.getWindowHeight();
    }

    public static ScreenFadeManager getInstance() {
        return instance;
    }
```
- 重构后
```java
public class ScreenFadeManager{
    public enum State {
        INACTIVE,
        FADING_OUT,
        FADING_IN,
        FADING_OUT_FINAL
    }

    private static ScreenFadeManager instance;

    private State state;
    private float timer;
    private float fadeDuration; // 淡化时间(单段)
    private Runnable onMidpoint; // 在淡出完全变黑时调用
    private Runnable onComplete; // 在淡入完全变亮时调用
    private float WINDOW_WIDTH;
    private float WINDOW_HEIGHT;

    // static {
    //    instance = new ScreenFadeManager();
    // }

    private ScreenFadeManager(float width, float height) {
        state = State.INACTIVE;
        timer = 0.0f;
        fadeDuration = 1.0f;
        WINDOW_WIDTH = width;
        WINDOW_HEIGHT = height;
    }

    public static ScreenFadeManager getInstance() {
        if (instance == null) {
             // Fallback or throw error if not initialized. 
             // For now, we can't easily get width/height here without Game.
             // So we will rely on Game initializing it.
             // Or we keep the old constructor for now but mark deprecated?
             // Let's just change the initialization in Game.
             throw new RuntimeException("ScreenFadeManager not initialized");
        }
        return instance;
    }

    public static void init(float width, float height) {
        instance = new ScreenFadeManager(width, height);
    }
```

## UIManager.java
- 重构前
```java
public class UIManager extends UIBase {
    public enum MenuState {
        BEGIN,
        MAIN,
        FIGHT_SELECT_ENEMY,
        FIGHT,
        ACT_SELECT_ENEMY,
        ACT_SELECT_ACT,
        ACT,
        ITEM_SELECT_ITEM,
        ITEM,
        MERCY_SELECT_ENEMY,
        MERCY_SELECT_SPARE,
        MERCY,
        SUCCESS
    }

    private static UIManager instance;

    private Player player;

    private EnemyManager enemyManager;
    private FontManager fontManager;
    private TypeWriter menuTypeWriter;
    private BgUIManager bgUIManager;
    private AttackAnimManager attackAnimManager;
    private BattleFrameManager battleFrameManager;
    private GameOverUIManager gameOverUIManager;
    private BeginMenuManager beginMenuManager;
    private SoundManager soundManager;
    private UIContainer rootContainer;
    private String pendingItemDescription = null;

    public MenuState menuState = MenuState.BEGIN;

    public int selectedEnemy = 0;
    public int selectedAct = 0;
    public int selectedItem = 0;
    public int itemListFirstIndex = 0;
    public int selectedAction = -1;

    public boolean sliceSEPlayed = false;
    private boolean isBackToMain = false;

    static {
        instance = new UIManager();
    }

    private UIManager() {
        super();
        fontManager = FontManager.getInstance();
        player = Game.getPlayer();
        menuTypeWriter = new TypeWriter(fontManager);
        bgUIManager = new BgUIManager(fontManager, player);
        attackAnimManager = new AttackAnimManager(fontManager, player);
        battleFrameManager = new BattleFrameManager(player);
        gameOverUIManager = new GameOverUIManager(menuTypeWriter, player);
        beginMenuManager = new BeginMenuManager(fontManager);
        enemyManager = EnemyManager.getInstance();
        soundManager = SoundManager.getInstance();

        // create root UI container and register sub-managers as children
        rootContainer = new UIContainer();
        rootContainer.addChild(menuTypeWriter);
        rootContainer.addChild(bgUIManager);
        rootContainer.addChild(attackAnimManager);
        rootContainer.addChild(battleFrameManager);
        rootContainer.addChild(gameOverUIManager);
        rootContainer.addChild(beginMenuManager);
    }

    public static UIManager getInstance() {
        if(instance == null) {
            synchronized(UIManager.class) {
                if(instance == null) {
                    instance = new UIManager();
                }
            }
        }
        return instance;
    }
```
- 重构后
```java
public class UIManager extends UIBase {
    public enum MenuState {
        BEGIN,
        MAIN,
        FIGHT_SELECT_ENEMY,
        FIGHT,
        ACT_SELECT_ENEMY,
        ACT_SELECT_ACT,
        ACT,
        ITEM_SELECT_ITEM,
        ITEM,
        MERCY_SELECT_ENEMY,
        MERCY_SELECT_SPARE,
        MERCY,
        SUCCESS
    }

    // private static UIManager instance; // Removed Singleton

    private Player player;

    private EnemyManager enemyManager;
    private FontManager fontManager;
    private TypeWriter menuTypeWriter;
    private BgUIManager bgUIManager;
    private AttackAnimManager attackAnimManager;
    private BattleFrameManager battleFrameManager;
    private GameOverUIManager gameOverUIManager;
    private BeginMenuManager beginMenuManager;
    private SoundManager soundManager;
    private UIContainer rootContainer;
    private String pendingItemDescription = null;

    public MenuState menuState = MenuState.BEGIN;

    public int selectedEnemy = 0;
    public int selectedAct = 0;
    public int selectedItem = 0;
    public int itemListFirstIndex = 0;
    public int selectedAction = -1;

    public boolean sliceSEPlayed = false;
    private boolean isBackToMain = false;

    // static {
    //    instance = new UIManager();
    // }

    public UIManager(Player player, EnemyManager enemyManager, SoundManager soundManager, FontManager fontManager) {
        super();
        this.player = player;
        this.enemyManager = enemyManager;
        this.soundManager = soundManager;
        this.fontManager = fontManager;
        
        menuTypeWriter = new TypeWriter(fontManager);
        bgUIManager = new BgUIManager(fontManager, player);
        attackAnimManager = new AttackAnimManager(fontManager, player, enemyManager);
        battleFrameManager = new BattleFrameManager(player);
        gameOverUIManager = new GameOverUIManager(menuTypeWriter, player);
        beginMenuManager = new BeginMenuManager(fontManager);

        // create root UI container and register sub-managers as children
        rootContainer = new UIContainer();
        rootContainer.addChild(menuTypeWriter);
        rootContainer.addChild(bgUIManager);
        rootContainer.addChild(attackAnimManager);
        rootContainer.addChild(battleFrameManager);
        rootContainer.addChild(gameOverUIManager);
        rootContainer.addChild(beginMenuManager);
    }

    // public static UIManager getInstance() { ... } // Removed
```

## Titan.java
- 重构前
```java
public class Titan extends Enemy {

    public Titan() {
        super("Titan", 6000, 6000, 114514, 19198);
        this.weakened = false;
        init();
    }

    private void init() {
        AnimationManager animationManager = AnimationManager.getInstance();
        soundManager = SoundManager.getInstance();
        Player player = Game.getPlayer();
        roundsPerWeaken = 2;
        defenseRate = initialDefenseRate;
        ……
```
- 重构后
```java
public class Titan extends Enemy {

    public Titan(Player player) {
        super("Titan", 6000, 6000, 114514, 19198);
        this.weakened = false;
        init(player);
    }

    private void init(Player player) {
        AnimationManager animationManager = AnimationManager.getInstance();
        soundManager = SoundManager.getInstance();
        roundsPerWeaken = 2;
        defenseRate = initialDefenseRate;
        ……
```